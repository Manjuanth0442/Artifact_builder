{"type": "PlanScript", "uri": null, "category": null, "eTag": null, "created": null, "modified": null, "id": "ca1c3ebf-f3c9-47ae-b746-842753270692", "name": "HPE-RHEL-deploy-teaming", "description": "Deploy Nic Teaming script", "status": null, "state": null, "planType": "deploy", "content": "# (C) Copyright 2018-2019 Hewlett Packard Enterprise Development LP\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software distributed\n# under the License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n# CONDITIONS OF ANY KIND, either express or implied. See the License for the\n# specific language governing permissions and limitations under the License.\n\nupload -<<END /EFI/HPE/isdeploy/scripts/03ibftTbonding-configuration.bash\necho \"deployment nic's bonding script started\"\n\ncat <<'CONF'> /etc/init.d/ibftT\n#! /bin/bash\n# chkconfig: 345 99 10\n# description: enable nic teaming for ibft interfaces\n\ncase \"$1\" in\nstart)\n\nmodprobe bonding\n\nsleep 20\necho +ibftTeam > /sys/class/net/bonding_masters\necho 1 > /sys/class/net/ibftTeam/bonding/mode\n\nFOUNDibft0=`grep \"ibft0\" /proc/net/dev`\nFOUNDibft1=`grep \"ibft1\" /proc/net/dev`\necho \"ibft0 : $FOUNDibft0\"\necho \"ibft1 : $FOUNDibft1\"\n\nif  [ -n \"$FOUNDibft0\" ]; then\nibftIP=`ip addr list ibft0 |grep -w \"inet\" |cut -d' ' -f6|cut -d'/' -f1`\nNetmask=`ip addr list ibft0 |grep -w \"inet\" |cut -d' ' -f6|cut -d'/' -f2`\necho $ibftIP\necho $Netmask\nelse\nibftIP=`ip addr list ibft1 |grep -w \"inet\" |cut -d' ' -f6|cut -d'/' -f1`\nNetmask=`ip addr list ibft1 |grep -w \"inet\" |cut -d' ' -f6|cut -d'/' -f2`\necho $ibftIP\necho $Netmask\nfi\n\nip addr add $ibftIP/$Netmask dev ibftTeam\n\n\nif [ -n \"$FOUNDibft0\" ]; then\nip addr flush dev ibft0\nip link set down ibft0\necho +ibft0 > /sys/class/net/ibftTeam/bonding/slaves\nip link set up ibftTeam\nip link set up ibft0\nfi\n\nif [ -n \"$FOUNDibft1\" ]; then\nip addr flush dev ibft1\nip link set down ibft1\necho +ibft1 > /sys/class/net/ibftTeam/bonding/slaves\nip link set up ibftTeam\nip link set up ibft1\nfi\n\n\necho 100 > /sys/class/net/ibftTeam/bonding/miimon\n\niscsiadm -P 1 -m session\n\nsleep 10\n\nip link set up ibft0\nip link set up ibft1\nip addr flush dev ibft0\nip addr flush dev ibft1\n\nsystemctl restart NetworkManager\n\n;;\n*)\necho \"Usage: /sbin/service new-service {start|stop}\"\nexit 1\nesac\nexit 0\n\n\nCONF\n\nchmod 755 /etc/init.d/ibftT\nchkconfig --add ibftT\nsystemctl enable ibftT\nservice ibftT start\nsystemctl start ibftT.service\n\necho \"deployment nic bonding script ended\"\n\n\nEND", "customAttributes": null, "hpProvided": true, "dependentArtifacts": null}